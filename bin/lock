#!/usr/bin/env bash

DISPLAY_RE="([0-9]+)x([0-9]+)\\+([0-9]+)\\+([0-9]+)"
IMAGE_RE="([0-9]+)x([0-9]+)"
LOCK="$HOME/disk/assets/lock.png"
PARAMS=""
OUTPUT_IMAGE="/tmp/lockscreen.png"

scrot -zo $OUTPUT_IMAGE

LOCK_IMAGE_INFO=`identify $LOCK`
[[ $LOCK_IMAGE_INFO =~ $IMAGE_RE ]]
IMAGE_WIDTH=${BASH_REMATCH[1]}
IMAGE_HEIGHT=${BASH_REMATCH[2]}

while read LINE
do
  if [[ $LINE =~ $DISPLAY_RE ]]; then
    WIDTH=${BASH_REMATCH[1]}
    HEIGHT=${BASH_REMATCH[2]}
    X=${BASH_REMATCH[3]}
    Y=${BASH_REMATCH[4]}
    POS_X=$(($X+$WIDTH/2-$IMAGE_WIDTH/2))
    POS_Y=$(($Y+$HEIGHT/2-$IMAGE_HEIGHT/2))

    PARAMS="$PARAMS $LOCK -geometry +$POS_X+$POS_Y -composite"
  fi
done <<<"`xrandr`"

convert $OUTPUT_IMAGE -scale 10% -scale 1000% $OUTPUT_IMAGE
convert $OUTPUT_IMAGE $PARAMS $OUTPUT_IMAGE

xset dpms 120
i3lock -i $OUTPUT_IMAGE -t -u -n
